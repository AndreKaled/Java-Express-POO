<div th:fragment="map">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-bottom: 15px;
        }
    </style>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map('map').setView([-3.1, -60.0], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        const pontos = [];
        let routeLine = null;

        map.on('click', (e) => {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            pontos.push({ latitude: lat, longitude: lng });
            L.marker([lat, lng]).addTo(map);

            console.log("Ponto marcado:", lat, lng);
        });

        async function salvarPontos() {
            if (pontos.length === 0) {
                alert("Nenhum ponto marcado!");
                return;
            }

            await fetch('/api/rota/salvar-pontos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pontos)
            });

            alert("Pontos salvos!");
        }

        async function otimizarRota() {
            const resp = await fetch('/api/rota/otimizar');
            const rota = await resp.json();

            if (!rota || !rota.coordenadas) {
                alert("Nenhuma rota retornada!");
                return;
            }

            if (routeLine) map.removeLayer(routeLine);

            const latlngs = rota.coordenadas.map(p => [p.latitude, p.longitude]);

            routeLine = L.polyline(latlngs, { color: 'blue' }).addTo(map);

            map.fitBounds(routeLine.getBounds());
        }
    </script>
</div>
